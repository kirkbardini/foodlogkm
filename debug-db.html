<!DOCTYPE html>
<html>
<head>
    <title>Debug IndexedDB</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .danger { background: #dc3545; color: white; }
        .warning { background: #ffc107; color: black; }
    </style>
</head>
<body>
    <h1>üîç Debug IndexedDB - FoodLog KM</h1>
    
    <div class="section info">
        <h3>üìä Status Atual</h3>
        <div id="status"></div>
    </div>
    
    <div class="section">
        <h3>üßπ A√ß√µes de Limpeza</h3>
        <button onclick="checkDatabase()" class="warning">üîç Verificar Banco</button>
        <button onclick="clearAllData()" class="danger">üóëÔ∏è Limpar TUDO</button>
        <button onclick="clearIndexedDB()" class="danger">üóëÔ∏è Limpar IndexedDB</button>
        <button onclick="clearLocalStorage()" class="warning">üßπ Limpar LocalStorage</button>
    </div>
    
    <div class="section">
        <h3>üìã Resultados</h3>
        <div id="results"></div>
    </div>

    <script>
        let db = null;
        
        async function checkDatabase() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>üîç Verificando banco de dados...</p>';
            
            try {
                // Verificar IndexedDB
                const request = indexedDB.open('foodlog-km-db', 1);
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    const transaction = db.transaction(['foods', 'entries', 'users'], 'readonly');
                    
                    const foodsStore = transaction.objectStore('foods');
                    const entriesStore = transaction.objectStore('entries');
                    const usersStore = transaction.objectStore('users');
                    
                    // Contar registros
                    const foodsCount = foodsStore.count();
                    const entriesCount = entriesStore.count();
                    const usersCount = usersStore.count();
                    
                    foodsCount.onsuccess = function() {
                        entriesCount.onsuccess = function() {
                            usersCount.onsuccess = function() {
                                results.innerHTML = `
                                    <div class="info">
                                        <h4>üìä Dados no IndexedDB:</h4>
                                        <p>üçé Alimentos: ${foodsCount.result}</p>
                                        <p>üìù Entradas: ${entriesCount.result}</p>
                                        <p>üë• Usu√°rios: ${usersCount.result}</p>
                                    </div>
                                `;
                            };
                        };
                    };
                };
                
                request.onerror = function() {
                    results.innerHTML = '<div class="error">‚ùå Erro ao abrir IndexedDB</div>';
                };
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        async function clearAllData() {
            const confirm = prompt('‚ö†Ô∏è ATEN√á√ÉO: Isso vai deletar TODOS os dados!\n\nDigite "DELETE ALL" para confirmar:');
            if (confirm !== 'DELETE ALL') {
                alert('‚ùå Opera√ß√£o cancelada');
                return;
            }
            
            const results = document.getElementById('results');
            results.innerHTML = '<p>üóëÔ∏è Limpando todos os dados...</p>';
            
            try {
                // 1. Limpar IndexedDB
                const deleteRequest = indexedDB.deleteDatabase('foodlog-km-db');
                deleteRequest.onsuccess = function() {
                    console.log('‚úÖ IndexedDB deletado');
                };
                deleteRequest.onerror = function() {
                    console.log('‚ùå Erro ao deletar IndexedDB');
                };
                
                // 2. Limpar localStorage
                localStorage.clear();
                console.log('‚úÖ localStorage limpo');
                
                // 3. Limpar sessionStorage
                sessionStorage.clear();
                console.log('‚úÖ sessionStorage limpo');
                
                // 4. Limpar cache do navegador (se poss√≠vel)
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        for (let name of names) {
                            caches.delete(name);
                        }
                        console.log('‚úÖ Cache limpo');
                    });
                }
                
                results.innerHTML = '<div class="success">‚úÖ Todos os dados foram limpos!</div>';
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        async function clearIndexedDB() {
            const confirm = prompt('‚ö†Ô∏è Deletar IndexedDB?\n\nDigite "DELETE" para confirmar:');
            if (confirm !== 'DELETE') {
                alert('‚ùå Opera√ß√£o cancelada');
                return;
            }
            
            const results = document.getElementById('results');
            results.innerHTML = '<p>üóëÔ∏è Deletando IndexedDB...</p>';
            
            try {
                const deleteRequest = indexedDB.deleteDatabase('foodlog-km-db');
                
                deleteRequest.onsuccess = function() {
                    results.innerHTML = '<div class="success">‚úÖ IndexedDB deletado com sucesso!</div>';
                };
                
                deleteRequest.onerror = function() {
                    results.innerHTML = '<div class="error">‚ùå Erro ao deletar IndexedDB</div>';
                };
                
                deleteRequest.onblocked = function() {
                    results.innerHTML = '<div class="error">‚ö†Ô∏è IndexedDB est√° em uso. Feche todas as abas da aplica√ß√£o e tente novamente.</div>';
                };
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        async function clearLocalStorage() {
            const confirm = prompt('‚ö†Ô∏è Limpar LocalStorage?\n\nDigite "CLEAR" para confirmar:');
            if (confirm !== 'CLEAR') {
                alert('‚ùå Opera√ß√£o cancelada');
                return;
            }
            
            const results = document.getElementById('results');
            
            try {
                localStorage.clear();
                sessionStorage.clear();
                results.innerHTML = '<div class="success">‚úÖ LocalStorage e SessionStorage limpos!</div>';
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        // Verificar status inicial
        window.onload = function() {
            const status = document.getElementById('status');
            status.innerHTML = `
                <p>üîç Verificando status inicial...</p>
                <p>üì± LocalStorage: ${localStorage.length} itens</p>
                <p>üì± SessionStorage: ${sessionStorage.length} itens</p>
                <p>üåê IndexedDB: Verificando...</p>
            `;
            
            // Verificar se IndexedDB existe
            const request = indexedDB.open('foodlog-km-db', 1);
            request.onsuccess = function() {
                status.innerHTML += '<p>‚úÖ IndexedDB existe</p>';
            };
            request.onerror = function() {
                status.innerHTML += '<p>‚ùå IndexedDB n√£o existe</p>';
            };
        };
    </script>
</body>
</html>
